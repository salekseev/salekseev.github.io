<!DOCTYPE html>

<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
		<meta http-equiv="x-ua-compatible" content="ie=edge">
		<meta property="og:title" content="Using nested maps in Terraform input variables - ~salekseev"></meta>
 		
		<meta property="og:description" content="" />
		
		<meta property="og:type" content="article"></meta>
		<meta property="og:url" content="https://salekseev.com/posts/nested-maps-in-terraform-variables/"></meta>
		<meta property="og:image" content="https://docs.gitea.io/images/gitea.png"></meta>
		<meta name="generator" content="Hugo 0.43" />

		<title>Using nested maps in Terraform input variables - ~salekseev</title>

		
		

		

		<link rel="canonical" href="https://salekseev.com/posts/nested-maps-in-terraform-variables/">

		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" />
		<link rel="stylesheet" href="https://salekseev.com/styles/main.css">

		<link rel="shortcut icon" type="image/x-icon" href="https://salekseev.com/images/favicon.png">
		<link rel="icon" type="image/x-icon" href="https://salekseev.com/images/favicon.png">
	</head>
	<body>

<nav class="navbar">
	<div class="container">
		<div class="navbar-brand">
			<a class="navbar-item" href="https://salekseev.com/">
				<img src="https://salekseev.com/images/gitea.png" alt="~salekseev">
			</a>
			<span class="navbar-burger burger" data-target="navMenu" aria-label="menu" aria-expanded="false">
              <span></span>
              <span></span>
              <span></span>
            </span>
		</div>
		<div class="navbar-menu" id="navMenu">
			<div class="navbar-end">
				<span class="navbar-item logo"><img src="https://salekseev.com/images/gitea.png" alt="~salekseev"></span>


			</div>
		</div>
		<div class="navbar-background" id="navbar-background"></div>
	</div>
</nav>

<section class="section">
	<div class="container is-centered page">
		<div class=" content">
			<p>Here&rsquo;s my working terraform file:</p>
<div class="highlight"><pre style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-terraform" data-lang="terraform"><span style="color:#815ba4">variable</span> <span style="color:#48b685">&#34;create&#34;</span> {<span style="color:#ef6155">
</span><span style="color:#ef6155">  description =</span> <span style="color:#48b685">&#34;Whether to the resources&#34;</span>
  <span style="color:#ef6155">default     = true
</span><span style="color:#ef6155"></span>}<span style="color:#ef6155">
</span><span style="color:#ef6155">
</span><span style="color:#ef6155">variable</span> <span style="color:#48b685">&#34;config&#34;</span> {<span style="color:#ef6155">
</span><span style="color:#ef6155">  type        =</span> <span style="color:#48b685">&#34;map&#34;</span>
  <span style="color:#ef6155">description =</span> <span style="color:#48b685">&#34;Instances to create (map of maps keyed on &#39;name&#39;)&#34;</span>
}<span style="color:#ef6155">
</span><span style="color:#ef6155">
</span><span style="color:#ef6155">data</span> <span style="color:#48b685">&#34;template_file&#34; &#34;config_instance&#34;</span> {<span style="color:#ef6155">
</span><span style="color:#ef6155">  count    =</span> <span style="color:#48b685">&#34;${length(var.config)}&#34;</span>
  <span style="color:#ef6155">template =</span> <span style="color:#48b685">&#34;${element(keys(var.config), count.index)}&#34;</span>
}<span style="color:#ef6155">
</span><span style="color:#ef6155">
</span><span style="color:#ef6155">data</span> <span style="color:#48b685">&#34;template_file&#34; &#34;config_instance_type&#34;</span> {<span style="color:#ef6155">
</span><span style="color:#ef6155">  count    =</span> <span style="color:#48b685">&#34;${length(var.config)}&#34;</span>
  <span style="color:#ef6155">template =</span> <span style="color:#48b685">&#34;${lookup(var.config[element(keys(var.config), count.index)], &#34;instance_type&#34;)}&#34;</span>
}<span style="color:#ef6155">
</span><span style="color:#ef6155">
</span><span style="color:#ef6155">data</span> <span style="color:#48b685">&#34;aws_ami&#34; &#34;ubuntu&#34;</span> {<span style="color:#ef6155">
</span><span style="color:#ef6155">  most_recent = true
</span><span style="color:#ef6155">
</span><span style="color:#ef6155">  filter </span>{<span style="color:#ef6155">
</span><span style="color:#ef6155">    name   =</span> <span style="color:#48b685">&#34;name&#34;</span>
    <span style="color:#ef6155">values = </span>[<span style="color:#ef6155">&#34;ubuntu/images/hvm-ssd/ubuntu-bionic-18</span>.<span style="color:#ef6155">04-amd64-server-*&#34;</span>]<span style="color:#ef6155">
</span><span style="color:#ef6155">  </span>}<span style="color:#ef6155">
</span><span style="color:#ef6155">
</span><span style="color:#ef6155">  filter </span>{<span style="color:#ef6155">
</span><span style="color:#ef6155">    name   =</span> <span style="color:#48b685">&#34;virtualization-type&#34;</span>
    <span style="color:#ef6155">values = </span>[<span style="color:#ef6155">&#34;hvm&#34;</span>]<span style="color:#ef6155">
</span><span style="color:#ef6155">  </span>}<span style="color:#ef6155">
</span><span style="color:#ef6155">
</span><span style="color:#ef6155">  owners = </span>[<span style="color:#ef6155">&#34;099720109477&#34;</span>]<span style="color:#ef6155"> # Canonical
</span><span style="color:#ef6155"></span>}<span style="color:#ef6155">
</span><span style="color:#ef6155">
</span><span style="color:#ef6155">resource</span> <span style="color:#48b685">&#34;aws_instance&#34; &#34;instance&#34;</span> {<span style="color:#ef6155">
</span><span style="color:#ef6155">  count =</span> <span style="color:#48b685">&#34;${var.create ? length(var.config) : 0}&#34;</span>

  <span style="color:#ef6155">ami           =</span> <span style="color:#48b685">&#34;${data.aws_ami.ubuntu.id}&#34;</span>
  <span style="color:#ef6155">instance_type =</span> <span style="color:#48b685">&#34;${element(data.template_file.config_instance_type.*.rendered, count.index)}&#34;</span>

  <span style="color:#ef6155">tags </span>{<span style="color:#ef6155">
</span><span style="color:#ef6155">    Name =</span> <span style="color:#48b685">&#34;${element(data.template_file.config_instance.*.rendered, count.index)}&#34;</span>
  }<span style="color:#ef6155">
</span><span style="color:#ef6155"></span>}<span style="color:#ef6155">
</span><span style="color:#ef6155">
</span><span style="color:#ef6155">output</span> <span style="color:#48b685">&#34;instance_id&#34;</span> {<span style="color:#ef6155">
</span><span style="color:#ef6155">  value =</span> <span style="color:#48b685">&#34;${length(aws_instance.instance.*.id) &gt; 0 ? element(concat(aws_instance.instance.*.id, list(&#34;&#34;)), 0) : &#34;&#34;}&#34;</span>
}</code></pre></div>
<p>Given the following variable file:</p>
<div class="highlight"><pre style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-terraform" data-lang="terraform"><span style="color:#06b6ef">create</span> <span style="color:#5bc4bf">=</span> <span style="color:#fec418">true</span>

<span style="color:#06b6ef">config</span> <span style="color:#5bc4bf">=</span> {
<span style="color:#06b6ef">  &#34;instance-01&#34;</span> <span style="color:#5bc4bf">=</span> {
<span style="color:#06b6ef">    instance_type</span> <span style="color:#5bc4bf">=</span> <span style="color:#48b685">&#34;t2.micro&#34;</span>
  }

<span style="color:#06b6ef">  &#34;instance-02&#34;</span> <span style="color:#5bc4bf">=</span> {
<span style="color:#06b6ef">    instance_type</span> <span style="color:#5bc4bf">=</span> <span style="color:#48b685">&#34;t2.nano&#34;</span>
  }
}</code></pre></div>
<p>Terraform would produce the following plan:</p>
<div class="highlight"><pre style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4">$ terraform plan -var-file=test.tfvars
Refreshing Terraform state in-memory prior to plan...
The refreshed state will be used to calculate this plan, but will not be
persisted to local or remote state storage.

data.template_file.config_instance_type[0]: Refreshing state...
data.template_file.config_instance[1]: Refreshing state...
data.template_file.config_instance[0]: Refreshing state...
data.template_file.config_instance_type[1]: Refreshing state...
data.aws_ami.ubuntu: Refreshing state...

------------------------------------------------------------------------

An execution plan has been generated and is shown below.
Resource actions are indicated with the following symbols:
  + create

Terraform will perform the following actions:

  + aws_instance.instance[0]
      id:                           &lt;computed&gt;
      ami:                          &#34;ami-5cc39523&#34;
      associate_public_ip_address:  &lt;computed&gt;
      availability_zone:            &lt;computed&gt;
      ebs_block_device.#:           &lt;computed&gt;
      ephemeral_block_device.#:     &lt;computed&gt;
      get_password_data:            &#34;false&#34;
      instance_state:               &lt;computed&gt;
      instance_type:                &#34;t2.micro&#34;
      ipv6_address_count:           &lt;computed&gt;
      ipv6_addresses.#:             &lt;computed&gt;
      key_name:                     &lt;computed&gt;
      network_interface.#:          &lt;computed&gt;
      network_interface_id:         &lt;computed&gt;
      password_data:                &lt;computed&gt;
      placement_group:              &lt;computed&gt;
      primary_network_interface_id: &lt;computed&gt;
      private_dns:                  &lt;computed&gt;
      private_ip:                   &lt;computed&gt;
      public_dns:                   &lt;computed&gt;
      public_ip:                    &lt;computed&gt;
      root_block_device.#:          &lt;computed&gt;
      security_groups.#:            &lt;computed&gt;
      source_dest_check:            &#34;true&#34;
      subnet_id:                    &lt;computed&gt;
      tags.%:                       &#34;1&#34;
      tags.Name:                    &#34;instance-01&#34;
      tenancy:                      &lt;computed&gt;
      volume_tags.%:                &lt;computed&gt;
      vpc_security_group_ids.#:     &lt;computed&gt;

  + aws_instance.instance[1]
      id:                           &lt;computed&gt;
      ami:                          &#34;ami-5cc39523&#34;
      associate_public_ip_address:  &lt;computed&gt;
      availability_zone:            &lt;computed&gt;
      ebs_block_device.#:           &lt;computed&gt;
      ephemeral_block_device.#:     &lt;computed&gt;
      get_password_data:            &#34;false&#34;
      instance_state:               &lt;computed&gt;
      instance_type:                &#34;t2.nano&#34;
      ipv6_address_count:           &lt;computed&gt;
      ipv6_addresses.#:             &lt;computed&gt;
      key_name:                     &lt;computed&gt;
      network_interface.#:          &lt;computed&gt;
      network_interface_id:         &lt;computed&gt;
      password_data:                &lt;computed&gt;
      placement_group:              &lt;computed&gt;
      primary_network_interface_id: &lt;computed&gt;
      private_dns:                  &lt;computed&gt;
      private_ip:                   &lt;computed&gt;
      public_dns:                   &lt;computed&gt;
      public_ip:                    &lt;computed&gt;
      root_block_device.#:          &lt;computed&gt;
      security_groups.#:            &lt;computed&gt;
      source_dest_check:            &#34;true&#34;
      subnet_id:                    &lt;computed&gt;
      tags.%:                       &#34;1&#34;
      tags.Name:                    &#34;instance-02&#34;
      tenancy:                      &lt;computed&gt;
      volume_tags.%:                &lt;computed&gt;
      vpc_security_group_ids.#:     &lt;computed&gt;


Plan: 2 to add, 0 to change, 0 to destroy.

------------------------------------------------------------------------

Note: You didn&#39;t specify an &#34;-out&#34; parameter to save this plan, so Terraform
can&#39;t guarantee that exactly these actions will be performed if
&#34;terraform apply&#34; is subsequently run.</pre></div>
<p>Due to weirdness in HCL library if you wanted to pass input variables using JSON, you would need to wrap the nested map inside a list like so:</p>
<div class="highlight"><pre style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
  <span style="color:#5bc4bf">&#34;create&#34;</span>: <span style="color:#815ba4">true</span>,
  <span style="color:#5bc4bf">&#34;config&#34;</span>: {
    <span style="color:#5bc4bf">&#34;instance-03&#34;</span>: [
      {
        <span style="color:#5bc4bf">&#34;instance_type&#34;</span>: <span style="color:#48b685">&#34;t2.micro&#34;</span>
      }
    ],
    <span style="color:#5bc4bf">&#34;instance-04&#34;</span>: [
      {
        <span style="color:#5bc4bf">&#34;instance_type&#34;</span>: <span style="color:#48b685">&#34;t2.nano&#34;</span>
      }
    ]
  }
}</code></pre></div>
<p>Terraform plan produced:</p>
<div class="highlight"><pre style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4">$ terraform plan -var-file=test.tfvars.json
Refreshing Terraform state in-memory prior to plan...
The refreshed state will be used to calculate this plan, but will not be
persisted to local or remote state storage.

data.template_file.config_instance[1]: Refreshing state...
data.template_file.config_instance_type[1]: Refreshing state...
data.template_file.config_instance_type[0]: Refreshing state...
data.template_file.config_instance[0]: Refreshing state...
data.aws_ami.ubuntu: Refreshing state...

------------------------------------------------------------------------

An execution plan has been generated and is shown below.
Resource actions are indicated with the following symbols:
  + create

Terraform will perform the following actions:

  + aws_instance.instance[0]
      id:                           &lt;computed&gt;
      ami:                          &#34;ami-5cc39523&#34;
      associate_public_ip_address:  &lt;computed&gt;
      availability_zone:            &lt;computed&gt;
      ebs_block_device.#:           &lt;computed&gt;
      ephemeral_block_device.#:     &lt;computed&gt;
      get_password_data:            &#34;false&#34;
      instance_state:               &lt;computed&gt;
      instance_type:                &#34;t2.micro&#34;
      ipv6_address_count:           &lt;computed&gt;
      ipv6_addresses.#:             &lt;computed&gt;
      key_name:                     &lt;computed&gt;
      network_interface.#:          &lt;computed&gt;
      network_interface_id:         &lt;computed&gt;
      password_data:                &lt;computed&gt;
      placement_group:              &lt;computed&gt;
      primary_network_interface_id: &lt;computed&gt;
      private_dns:                  &lt;computed&gt;
      private_ip:                   &lt;computed&gt;
      public_dns:                   &lt;computed&gt;
      public_ip:                    &lt;computed&gt;
      root_block_device.#:          &lt;computed&gt;
      security_groups.#:            &lt;computed&gt;
      source_dest_check:            &#34;true&#34;
      subnet_id:                    &lt;computed&gt;
      tags.%:                       &#34;1&#34;
      tags.Name:                    &#34;instance-03&#34;
      tenancy:                      &lt;computed&gt;
      volume_tags.%:                &lt;computed&gt;
      vpc_security_group_ids.#:     &lt;computed&gt;

  + aws_instance.instance[1]
      id:                           &lt;computed&gt;
      ami:                          &#34;ami-5cc39523&#34;
      associate_public_ip_address:  &lt;computed&gt;
      availability_zone:            &lt;computed&gt;
      ebs_block_device.#:           &lt;computed&gt;
      ephemeral_block_device.#:     &lt;computed&gt;
      get_password_data:            &#34;false&#34;
      instance_state:               &lt;computed&gt;
      instance_type:                &#34;t2.nano&#34;
      ipv6_address_count:           &lt;computed&gt;
      ipv6_addresses.#:             &lt;computed&gt;
      key_name:                     &lt;computed&gt;
      network_interface.#:          &lt;computed&gt;
      network_interface_id:         &lt;computed&gt;
      password_data:                &lt;computed&gt;
      placement_group:              &lt;computed&gt;
      primary_network_interface_id: &lt;computed&gt;
      private_dns:                  &lt;computed&gt;
      private_ip:                   &lt;computed&gt;
      public_dns:                   &lt;computed&gt;
      public_ip:                    &lt;computed&gt;
      root_block_device.#:          &lt;computed&gt;
      security_groups.#:            &lt;computed&gt;
      source_dest_check:            &#34;true&#34;
      subnet_id:                    &lt;computed&gt;
      tags.%:                       &#34;1&#34;
      tags.Name:                    &#34;instance-04&#34;
      tenancy:                      &lt;computed&gt;
      volume_tags.%:                &lt;computed&gt;
      vpc_security_group_ids.#:     &lt;computed&gt;


Plan: 2 to add, 0 to change, 0 to destroy.

------------------------------------------------------------------------

Note: You didn&#39;t specify an &#34;-out&#34; parameter to save this plan, so Terraform
can&#39;t guarantee that exactly these actions will be performed if
&#34;terraform apply&#34; is subsequently run.</pre></div>
<p>Please note that if default map is provided for the <code>config</code> variable, it would result in concatenation of those maps!</p>


			
	<div id="disqus_thread"></div>

	<script type="text/javascript">
		var disqus_shortname = 'salekseev-com';
		var disqus_identifier = 'https:\/\/salekseev.com\/posts\/nested-maps-in-terraform-variables\/';
		var disqus_title = 'Using nested maps in Terraform input variables';
		var disqus_url = 'https:\/\/salekseev.com\/posts\/nested-maps-in-terraform-variables\/';

		(function() {
			var dsq = document.createElement('script');

			dsq.type = 'text/javascript';
			dsq.async = true;
			dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';

			(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
		})();
	</script>

	<noscript>
		Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a>
	</noscript>


		</div>
	</div>
</section>

		<footer class="footer">
			<div class="container">
				<div class="content has-text-centered">
					<p>
						Copyright &copy; 2018 <a href="">Stas Alekseev</a>. All rights reserved. Made with <i class="fa fa-heart" aria-hidden="true"></i> and <a href="https://gohugo.io">Hugo</a>. Sponsored by <a href="http://inblockchain.com">INBlockchain</a>.
					</p>
					<p>
						
						<a class="nav-link" href="https://salekseev.com/en"></a>
						
					</p>
				</div>
			</div>
		</footer>

		<script>
            document.addEventListener('DOMContentLoaded', function () {

                
                var $navbarBurgers = Array.prototype.slice.call(document.querySelectorAll('.navbar-burger'), 0);

                
                if ($navbarBurgers.length > 0) {

                    
                    $navbarBurgers.forEach(function ($el) {
                        $el.addEventListener('click', function () {

                            
                            var target = $el.dataset.target;
                            var $target = document.getElementById(target);

                            
                            $el.classList.toggle('is-active');
                            $target.classList.toggle('is-active');


                            document.getElementById('navbar-background').classList.toggle('is-active');


                        });
                    });
                }

            });
		</script>

		</body>
</html>

