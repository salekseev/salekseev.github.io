<!DOCTYPE html>
<html lang="en-us">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <meta name="author" content="Stas Alekseev">
    <meta name="description" content="Stas Alekseev&#39;s personal website">
    <meta name="keywords" content="blog,developer,personal">

    <base href="https://salekseev.com/">
    <title>
  Using nested maps in Terraform input variables Â· ~salekseev
</title>

    <link rel="canonical" href="https://salekseev.com/posts/nested-maps-in-terraform-variables/">

    <link  rel="stylesheet" href="https://fonts.googleapis.com/css?family=Fira+Mono:400,700">
    <link rel="stylesheet" href="//cdn.rawgit.com/necolas/normalize.css/master/normalize.css">
    <link rel="stylesheet" href="https://salekseev.com/css/style.min.css">

    

    

    <link rel="icon" type="image/png" href="https://salekseev.com/images/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="https://salekseev.com/images/favicon-16x16.png" sizes="16x16">

    

    <meta name="generator" content="Hugo 0.43" />
  </head>

  <body class="">
    <main class="wrapper">
      <nav class="navigation">
  <section class="container">
    <a class="navigation-title" href="https://salekseev.com/">
      ~salekseev
    </a>
    <ul class="navigation-list  float-right ">
      
        
          <li class="navigation-item">
            <a class="navigation-link" href="https://salekseev.com/posts/">Blog</a>
          </li>
        
          <li class="navigation-item">
            <a class="navigation-link" href="https://salekseev.com/about/">About</a>
          </li>
        
      
      
    </ul>
  </section>
</nav>


      <div class="content">
        
  <section class="container post">
  <article>
    <header>
      <h1 class="title">Using nested maps in Terraform input variables</h1>
      <h2 class="date">July 11, 2018</h2>

      
    </header>

    <p>Here&rsquo;s my working terraform file:</p>
<div class="highlight"><pre style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-terraform" data-lang="terraform"><span style="color:#815ba4">variable</span> <span style="color:#48b685">&#34;create&#34;</span> {<span style="color:#ef6155">
</span><span style="color:#ef6155">  description =</span> <span style="color:#48b685">&#34;Whether to the resources&#34;</span>
  <span style="color:#ef6155">default     = true
</span><span style="color:#ef6155"></span>}<span style="color:#ef6155">
</span><span style="color:#ef6155">
</span><span style="color:#ef6155">variable</span> <span style="color:#48b685">&#34;config&#34;</span> {<span style="color:#ef6155">
</span><span style="color:#ef6155">  type        =</span> <span style="color:#48b685">&#34;map&#34;</span>
  <span style="color:#ef6155">description =</span> <span style="color:#48b685">&#34;Instances to create (map of maps keyed on &#39;name&#39;)&#34;</span>

  <span style="color:#ef6155">default = </span>{
    <span style="color:#48b685">&#34;instance-01&#34;</span> <span style="color:#ef6155">= </span>{<span style="color:#ef6155">
</span><span style="color:#ef6155">      instance_type =</span> <span style="color:#48b685">&#34;t2.micro&#34;</span>
    }

    <span style="color:#48b685">&#34;instance-02&#34;</span> <span style="color:#ef6155">= </span>{<span style="color:#ef6155">
</span><span style="color:#ef6155">      instance_type =</span> <span style="color:#48b685">&#34;t2.nano&#34;</span>
    }<span style="color:#ef6155">
</span><span style="color:#ef6155">  </span>}<span style="color:#ef6155">
</span><span style="color:#ef6155"></span>}<span style="color:#ef6155">
</span><span style="color:#ef6155">
</span><span style="color:#ef6155">data</span> <span style="color:#48b685">&#34;template_file&#34; &#34;config_instance&#34;</span> {<span style="color:#ef6155">
</span><span style="color:#ef6155">  count    =</span> <span style="color:#48b685">&#34;${length(var.config)}&#34;</span>
  <span style="color:#ef6155">template =</span> <span style="color:#48b685">&#34;${element(keys(var.config), count.index)}&#34;</span>
}<span style="color:#ef6155">
</span><span style="color:#ef6155">
</span><span style="color:#ef6155">data</span> <span style="color:#48b685">&#34;template_file&#34; &#34;config_instance_type&#34;</span> {<span style="color:#ef6155">
</span><span style="color:#ef6155">  count    =</span> <span style="color:#48b685">&#34;${length(var.config)}&#34;</span>
  <span style="color:#ef6155">template =</span> <span style="color:#48b685">&#34;${lookup(var.config[element(keys(var.config), count.index)], &#34;instance_type&#34;)}&#34;</span>
}<span style="color:#ef6155">
</span><span style="color:#ef6155">
</span><span style="color:#ef6155">data</span> <span style="color:#48b685">&#34;aws_ami&#34; &#34;ubuntu&#34;</span> {<span style="color:#ef6155">
</span><span style="color:#ef6155">  most_recent = true
</span><span style="color:#ef6155">
</span><span style="color:#ef6155">  filter </span>{<span style="color:#ef6155">
</span><span style="color:#ef6155">    name   =</span> <span style="color:#48b685">&#34;name&#34;</span>
    <span style="color:#ef6155">values = </span>[<span style="color:#ef6155">&#34;ubuntu/images/hvm-ssd/ubuntu-bionic-18</span>.<span style="color:#ef6155">04-amd64-server-*&#34;</span>]<span style="color:#ef6155">
</span><span style="color:#ef6155">  </span>}<span style="color:#ef6155">
</span><span style="color:#ef6155">
</span><span style="color:#ef6155">  filter </span>{<span style="color:#ef6155">
</span><span style="color:#ef6155">    name   =</span> <span style="color:#48b685">&#34;virtualization-type&#34;</span>
    <span style="color:#ef6155">values = </span>[<span style="color:#ef6155">&#34;hvm&#34;</span>]<span style="color:#ef6155">
</span><span style="color:#ef6155">  </span>}<span style="color:#ef6155">
</span><span style="color:#ef6155">
</span><span style="color:#ef6155">  owners = </span>[<span style="color:#ef6155">&#34;099720109477&#34;</span>]<span style="color:#ef6155"> # Canonical
</span><span style="color:#ef6155"></span>}<span style="color:#ef6155">
</span><span style="color:#ef6155">
</span><span style="color:#ef6155">resource</span> <span style="color:#48b685">&#34;aws_instance&#34; &#34;instance&#34;</span> {<span style="color:#ef6155">
</span><span style="color:#ef6155">  count =</span> <span style="color:#48b685">&#34;${var.create ? length(var.config) : 0}&#34;</span>

  <span style="color:#ef6155">ami           =</span> <span style="color:#48b685">&#34;${data.aws_ami.ubuntu.id}&#34;</span>
  <span style="color:#ef6155">instance_type =</span> <span style="color:#48b685">&#34;${element(data.template_file.config_instance_type.*.rendered, count.index)}&#34;</span>

  <span style="color:#ef6155">tags </span>{<span style="color:#ef6155">
</span><span style="color:#ef6155">    Name =</span> <span style="color:#48b685">&#34;${element(data.template_file.config_instance.*.rendered, count.index)}&#34;</span>
  }<span style="color:#ef6155">
</span><span style="color:#ef6155"></span>}<span style="color:#ef6155">
</span><span style="color:#ef6155">
</span><span style="color:#ef6155">output</span> <span style="color:#48b685">&#34;instance_id&#34;</span> {<span style="color:#ef6155">
</span><span style="color:#ef6155">  value =</span> <span style="color:#48b685">&#34;${length(aws_instance.instance.*.id) &gt; 0 ? element(concat(aws_instance.instance.*.id, list(&#34;&#34;)), 0) : &#34;&#34;}&#34;</span>
}</code></pre></div>
<p>Terraform would produce the following plan using defaults:</p>
<div class="highlight"><pre style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4">$ terraform plan
Refreshing Terraform state in-memory prior to plan...
The refreshed state will be used to calculate this plan, but will not be
persisted to local or remote state storage.

data.template_file.config_instance_type[1]: Refreshing state...
data.template_file.config_instance[0]: Refreshing state...
data.template_file.config_instance_type[0]: Refreshing state...
data.template_file.config_instance[1]: Refreshing state...
data.aws_ami.ubuntu: Refreshing state...

------------------------------------------------------------------------

An execution plan has been generated and is shown below.
Resource actions are indicated with the following symbols:
  + create

Terraform will perform the following actions:

  + aws_instance.instance[0]
      id:                           &lt;computed&gt;
      ami:                          &#34;ami-5cc39523&#34;
      associate_public_ip_address:  &lt;computed&gt;
      availability_zone:            &lt;computed&gt;
      ebs_block_device.#:           &lt;computed&gt;
      ephemeral_block_device.#:     &lt;computed&gt;
      get_password_data:            &#34;false&#34;
      instance_state:               &lt;computed&gt;
      instance_type:                &#34;t2.micro&#34;
      ipv6_address_count:           &lt;computed&gt;
      ipv6_addresses.#:             &lt;computed&gt;
      key_name:                     &lt;computed&gt;
      network_interface.#:          &lt;computed&gt;
      network_interface_id:         &lt;computed&gt;
      password_data:                &lt;computed&gt;
      placement_group:              &lt;computed&gt;
      primary_network_interface_id: &lt;computed&gt;
      private_dns:                  &lt;computed&gt;
      private_ip:                   &lt;computed&gt;
      public_dns:                   &lt;computed&gt;
      public_ip:                    &lt;computed&gt;
      root_block_device.#:          &lt;computed&gt;
      security_groups.#:            &lt;computed&gt;
      source_dest_check:            &#34;true&#34;
      subnet_id:                    &lt;computed&gt;
      tags.%:                       &#34;1&#34;
      tags.Name:                    &#34;instance-01&#34;
      tenancy:                      &lt;computed&gt;
      volume_tags.%:                &lt;computed&gt;
      vpc_security_group_ids.#:     &lt;computed&gt;

  + aws_instance.instance[1]
      id:                           &lt;computed&gt;
      ami:                          &#34;ami-5cc39523&#34;
      associate_public_ip_address:  &lt;computed&gt;
      availability_zone:            &lt;computed&gt;
      ebs_block_device.#:           &lt;computed&gt;
      ephemeral_block_device.#:     &lt;computed&gt;
      get_password_data:            &#34;false&#34;
      instance_state:               &lt;computed&gt;
      instance_type:                &#34;t2.nano&#34;
      ipv6_address_count:           &lt;computed&gt;
      ipv6_addresses.#:             &lt;computed&gt;
      key_name:                     &lt;computed&gt;
      network_interface.#:          &lt;computed&gt;
      network_interface_id:         &lt;computed&gt;
      password_data:                &lt;computed&gt;
      placement_group:              &lt;computed&gt;
      primary_network_interface_id: &lt;computed&gt;
      private_dns:                  &lt;computed&gt;
      private_ip:                   &lt;computed&gt;
      public_dns:                   &lt;computed&gt;
      public_ip:                    &lt;computed&gt;
      root_block_device.#:          &lt;computed&gt;
      security_groups.#:            &lt;computed&gt;
      source_dest_check:            &#34;true&#34;
      subnet_id:                    &lt;computed&gt;
      tags.%:                       &#34;1&#34;
      tags.Name:                    &#34;instance-02&#34;
      tenancy:                      &lt;computed&gt;
      volume_tags.%:                &lt;computed&gt;
      vpc_security_group_ids.#:     &lt;computed&gt;


Plan: 2 to add, 0 to change, 0 to destroy.

------------------------------------------------------------------------

Note: You didn&#39;t specify an &#34;-out&#34; parameter to save this plan, so Terraform
can&#39;t guarantee that exactly these actions will be performed if
&#34;terraform apply&#34; is subsequently run.</pre></div>
  </article>

  <br/>

  
      <div id="disqus_thread"></div>
<script>
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "salekseev-com" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
  
  
</section>

      </div>

      <footer class="footer">
  <section class="container">
    
      <p>Â© Stas Alekseev, 2014 - 2018</p>
    
     
  </section>
</footer>

    </main>

    

  </body>

</html>
